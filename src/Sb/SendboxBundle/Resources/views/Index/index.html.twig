{% extends "SbSendboxBundle::layout.html.twig" %}
{% block stylesheets %}
  {{ parent() }}

  {% stylesheets
    '@SbSendboxBundle/Resources/public/css/fileuploader.css'
    'bundles/sbsendbox/css/chosen.css'
    filter='cssrewrite'
  %}
     <link rel="stylesheet" type="text/css" media="screen" href="{{ asset_url }}" />
  {% endstylesheets %}
{% endblock %}
{% block javascripts %}
  {{ parent() }}
  {% javascripts
    '@SbSendboxBundle/Resources/public/js/plupload.js'
    '@SbSendboxBundle/Resources/public/js/plupload.html5.js'
    '@SbSendboxBundle/Resources/public/js/plupload.flash.js'
    '@SbSendboxBundle/Resources/public/js/chosen.jquery.min.js'
    '@SbSendboxBundle/Resources/public/js/jquery.scrollTo-1.4.2-min.js'
  %}
   <script type="text/javascript" src="{{ asset_url }}"></script>
{% endjavascripts %}
{% endblock %}
{% block content %}
   
<div style="position:relative;top:10%;">
  <h1 class="left" id="title">Post &amp; Send files</h1>
  <div style="clear:both"></div>
  <div class="publish">
    <form id="upload_form">
      <div id="uploader">
        <div id="pickfiles" title="Ajouter des fichiers" class="tagsinput overflow" style="height: 100px;margin-left:0;box-sizing:border-box;-moz-box-sizing:border-box;width:100%">No runtime found.</div>
        <div id="progress"><div class="qq-upload-size"></div></div>
      </div>
      <div style="border-top:1px solid #E8E8E8;padding-top:10px;">
        <input type="text" title="Votre email" name="fromMail" id="fromMail" rel="empty" value="Votre email" style="display:block;" />
        <select data-placeholder="Liste des destinataires..." multiple="multiple" id="toMail" name="toMail" style="box-sizing:border-box;-moz-box-sizing:border-box;width:100%"></select><br />
        <button id="sendMail" class="btn btn-success disabled right" disabled="disabled">Envoyer <i class="icon-envelope icon-white"></i></button>
        <div class="clear"></div>
      </div>
    </form>
  </div>
</div>
   <script>
    $("#fromMail").focus(function() {
      if($(this).val()=="Votre email"){ 
        $(this).val('');
      }
   });
   $("#fromMail").blur(function() {
      if($(this).val()==""){
        $(this).val('Votre email');
      }
   });
    
    var uploader = new plupload.Uploader({
      runtimes : 'html5,flash',
      flash_swf_url : '{{ asset('/bundles/sbsendbox/js/plupload.flash.swf') }}',
      browse_button : 'pickfiles',
      container: 'uploader',
      max_file_size : '1gb',
      chunk_size : '5mb',
      url : "{{ path('upload') }}"
    });

    uploader.bind('Init', function(up, params) {
      $('#pickfiles').html("");
      $('#pickfiles').append('<em>Cliquez pour t&eacute;l&eacute;charger des fichiers</em>')
    });

    uploader.bind('FilesAdded', function(up, files) {
      for (var i in files) {
        $('#pickfiles').append('<span id="' + files[i].id + '" class="tag btn"><span>' + files[i].name + ' (' + plupload.formatSize(files[i].size) + ') <img src="" /></span></span>');
      }
    });

    uploader.bind('UploadProgress', function(up, file) {
      //$('#'+file.id).css('background-color', 'rgb('+(247-file.percent*156/100)+', '+(197-file.percent*13/100)+', '+(25+file.percent*66/100)+')');
      $('#'+file.id).css('border-color', 'rgba('+(197-file.percent*156/100)+', '+(147-file.percent*13/100)+', '+(25+file.percent*66/100)+', 0.5)');
      $('#progress .qq-upload-size').css('width', up.total.percent+'%');
    });

    uploader.bind('QueueChanged', function(up) {
      $('#progress').css('display', 'block');
      $('#pickfiles em').hide();
      up.start();
      return false;
    });

    uploader.bind('UploadComplete', function(up, files) {
      $('#sendMail').removeAttr('disabled');
      $('#sendMail').removeClass('disabled');
    });

    uploader.bind('BeforeUpload', function(up, file) {
      $('#'+file.id+' img').attr('src', '{{ asset('/bundles/sbsendbox/images/mini-loader.gif') }}');
      $('#pickfiles').scrollTo($('#'+file.id));
      $('#'+file.id+'-loader').show();
    });

    uploader.bind('FileUploaded', function(up, file) {
      $('#'+file.id+' img').remove();
      $('#'+file.id).append('<i class="icon-ok"></i>');
    });

    uploader.init();
    
    $("#validCaptcha").click(function() {
        $("#recaptcha-container").hide();
        $("#upload_form").show();
    });

    $('#uploader').bind('dragenter', function(e) {
      if (!isValidFileDrag(e)) return;
      $('#dropdown').show();
    });

    $('#uploader').bind('dragleave', function(e) {
      if (!isValidFileDrag(e)) return;
      $('#dropdown').hide();
    });

    $("#sendMail").click(function() {
      $.ajax({
        type: "post",
        url: "{{ path('send') }}",
        data: $('form').serialize(),
        success: function(msg){
          if(msg=="SUCCESS")
            $('.publish').html('Votre message a été correctement envoyé');
          else
            $('.publish').html(msg);
        }
      });
      return false;
    });

    $('#toMail').chosen({
      create_option: true,
      persistent_create_option: true
    });

   </script>
{% endblock %}
